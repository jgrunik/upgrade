<!DOCTYPE html>
<html lang="en" x-data="state()" :class="{dark: dark_mode}">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upgrade</title>
    <link
      id="favicon"
      rel="icon"
      href="data:image/svg+xml,
      <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
        <text y='0.6em' font-size='160'>â™ </text></svg>"
    />
    <script defer src="//unpkg.com/alpinejs"></script>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script type="module" src="index.js"></script>
    <script>
      // set peer.id via network (async)
      const peer = new Peer(localStorage.getItem("peer_id"));

      // peer.id has been set
      const peer_id = new Promise((resolve) =>
        peer.on("open", (peer_id) => {
          localStorage.setItem("peer_id", peer_id);
          resolve(peer_id);
        })
      );

      const urlSearchParams = new URLSearchParams(location.search);

      const state = {
        get peer_id() {
          return localStorage.getItem("peer_id");
        },
        set peer_id(value) {
          return localStorage.setItem("peer_id", value);
        },
        get nickname() {
          return localStorage.getItem("nickname");
        },
        set nickname(value) {
          return localStorage.setItem("nickname", value);
        },
        get avatar_seed() {
          return localStorage.getItem("avatar_seed");
        },
        set avatar_seed(value) {
          return localStorage.setItem("avatar_seed", value);
        },
        dark_mode:
          ((storage = localStorage.getItem("dark_mode")),
          storage !== null
            ? storage === "true"
            : window.matchMedia &&
              window.matchMedia("(prefers-color-scheme: dark)").matches),
        toggle_dark_mode() {
          this.dark_mode = !this.dark_mode;
          localStorage.setItem("dark_mode", this.dark_mode);
        },
        room_id: urlSearchParams.get("room"),

        async init() {
          this.avatar_seed ??=
            ((seed = window.crypto.randomUUID()),
            localStorage.setItem("avatar_seed", seed),
            seed);

          this.peer_id ??= await peer.id;
        },

        avatarImgSrc(options = {}) {
          const url = new URL("https://api.dicebear.com/7.x/lorelei/svg");
          Object.entries({
            seed: window.crypto.randomUUID(),
            radius: 15,
            ...options,
          }).forEach(([k, v]) => url.searchParams.set(k, v));
          return url;
        },
      };

      document.addEventListener("alpine:init", () => {
        Alpine.data("state", () => state);
      });

      async function openRoom() {
        // initialise peer
        const room_peer = await new Promise((resolve) => {
          const peer = new Peer();
          peer.on("open", (room_peer_id) => {
            resolve(peer);
          });
        });

        // update URL
        history.pushState({}, "", "?room=" + room_peer.id);

        // show room invite

        // show connected players

        // show start game button
      }

      function copyRoomLinkToClipboard() {
        navigator.clipboard.writeText(location.href);
      }

      if (state.dark_mode) {
        document.documentElement.classList.add("dark");
      }
    </script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/papercss/dist/paper.min.css"
    />
    <style>
      [x-cloak] {
        display: none;
      }

      button,
      .not-selectable {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      #avatar_button,
      #avatar_button:focus {
        border-style: dashed;
      }

      #nickname_input,
      #nickname_input:focus {
        border-style: dashed;
      }

      footer p > span > img {
        border: none;
      }

      footer p > a,
      footer p > a:visited {
        color: var(--secondary);
        background-image: none;
      }
    </style>
  </head>

  <body
    class="paper"
    style="
      margin: 0;
      border: 0;
      box-shadow: none;
      padding-top: 0;
      padding-bottom: 1ch;
      height: 100vh;
      max-height: 100vh;
      display: grid;
      align-content: space-between;
    "
  >
    <header
      class="container row not-selectable"
      style="justify-content: space-between; width: 100%"
    >
      <h1 style="margin-top: 20px; margin-bottom: 20px">â™  Upgrade</h1>

      <button
        id="dark_mode_btn"
        class="card border"
        x-cloak
        style="margin-right: 0; font-size: x-large; margin: 0; padding: 0.5rem"
        popover-left="toggle dark mode"
        x-text="dark_mode ? 'ðŸŒœï¸Ž' : 'â˜€'"
        x-on:click="toggle_dark_mode()"
      ></button>
    </header>

    <main>
      <section style="display: grid; justify-items: center">
        <button
          id="avatar_button"
          class="container border-3 border-dashed shadow shadow-small"
          style="
            padding: 0px;
            margin: 20px;
            max-width: 28ch;
            aspect-ratio: 1;
            height: auto;
          "
        >
          <img
            id="avatar"
            alt="avatar"
            :src="avatarImgSrc({seed:avatar_seed})"
            x-cloak
            draggable="false"
            style="border: 0; margin: 0"
          />
        </button>
        <input
          id="nickname_input"
          x-ref="nickname_input"
          type="text"
          placeholder="nickname goes here â™¥"
          class="container border-3 border-dashed shadow shadow-hover shadow-small"
          x-model="nickname"
          maxlength="24"
          style="text-align: center; font-size: x-large; max-width: 24ch"
        />
      </section>
      <section
        class="row flex-center"
        style="margin-top: 20px; margin-bottom: 0"
      >
        <button
          x-on:click="openRoom"
          class="btn-secondary-outline"
          style="font-size: xx-large; font-variant: small-caps"
        >
          âš” Open Room
        </button>
        <button
          x-on:click="copyRoomLinkToClipboard"
          x-show="false"
          x-cloak
          class="margin"
        >
          ðŸ”— Invite
        </button>
      </section>
    </main>

    <footer style="text-align: right">
      <p
        xmlns:cc="http://creativecommons.org/ns#"
        xmlns:dct="http://purl.org/dc/terms/"
        style="margin-bottom: 0; font-style: italic; font-size: small"
      >
        <a
          rel="cc:attributionURL"
          property="dct:title"
          href="https://github.com/jgrunik/upgrade"
          >Upgrade</a
        >
        by
        <a
          rel="cc:attributionURL dct:creator"
          property="cc:attributionName"
          href="https://github.com/jgrunik"
          >Joshua Grunik</a
        >
        is licensed under
        <a
          rel="license noopener noreferrer"
          href="http://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1"
          target="_blank"
          >CC BY-NC-SA 4.0</a
        >
        <br />
        <span style="display: inline-flex; height: 2ch">
          <img
            style="margin-left: 3px; vertical-align: text-bottom"
            src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"
          />
          <img
            style="margin-left: 3px; vertical-align: text-bottom"
            src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"
          />
          <img
            style="margin-left: 3px; vertical-align: text-bottom"
            src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1"
          /><img
            style="margin-left: 3px; vertical-align: text-bottom"
            src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1"
          />
        </span>
      </p>
    </footer>
  </body>
</html>
