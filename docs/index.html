<!DOCTYPE html>
<html lang="en" x-data="{ dark: false }" :class="{ dark }">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upgrade 🃏</title>
    <link
      rel="icon"
      href="data:image/svg+xml,
      <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
        <text y='.9em' font-size='90'>🃏</text></svg>"
    />
    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script>
      // set peer.id via network (async)
      const peer = new Peer(localStorage.getItem("peer_id"));

      // peer.id has been set
      peer.on("open", (peer_id) => {
        localStorage.setItem("peer_id", peer_id);
      });

      const nickname = localStorage.getItem("nickname");
      const avatar_seed =
        localStorage.getItem("avatar_seed") ??
        ((seed = window.crypto.randomUUID()),
        localStorage.setItem("avatar_seed", seed),
        seed);

      const urlSearchParams = new URLSearchParams(location.search);
      const room_id = urlSearchParams.get("room");

      const isHost = room_id === null;

      function avatarImgSrc(options = {}) {
        options = { seed: window.crypto.randomUUID(), radius: 15, ...options };
        const url = new URL("https://api.dicebear.com/7.x/lorelei/svg");
        Object.entries(options).forEach(([k, v]) => url.searchParams.set(k, v));
        return url;
      }

      document.addEventListener("alpine:init", async () => {
        await Alpine.data("state", () => {
          let peer_id = peer.id;
          return {
            isHost,
            peer_id,
            nickname,
            avatar_seed,
            avatarImgSrc,
            room_id,
          };
        });
      });

      async function openRoom() {
        // initialise peer
        const room_peer = await new Promise((resolve) => {
          const peer = new Peer();
          peer.on("open", (room_peer_id) => {
            resolve(peer);
          });
        });

        // update URL
        history.pushState({}, "", "?room=" + room_peer.id);

        // show room invite

        // show connected players

        // show start game button
      }

      function setLocalStorage(key) {
        return (val) => localStorage.setItem(key, val);
      }

      function copyRoomLinkToClipboard() {
        navigator.clipboard.writeText(location.href);
      }
    </script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/papercss/dist/paper.min.css"
    />
    <style>
      [x-cloak] {
        display: none;
      }

      button,
      .not-selectable {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      #avatar_button,
      #avatar_button:focus {
        border-style: dashed;
      }

      #nickname_input,
      #nickname_input:focus {
        border-style: dashed;
      }

      footer p > span > img {
        border: none;
      }

      footer p > a,
      footer p > a:visited {
        color: var(--secondary);
        background-image: none;
      }
    </style>
  </head>

  <body
    x-cloak
    x-data="state()"
    class="paper"
    style="
      margin: 0;
      border: 0;
      box-shadow: none;
      padding-top: 0;
      height: 100vh;
      max-height: 100vh;
      display: grid;
      align-content: space-between;
    "
  >
    <header
      class="container row not-selectable"
      style="justify-content: space-between; width: 100%"
    >
      <h3 style="margin-top: 20px; margin-bottom: 20px">Upgrade 🃏</h3>

      <button
        popover-left="toggle dark mode"
        x-on:click="dark = !dark"
        class="btn-small"
        style="margin-right: 0"
      >
        ☀
      </button>
    </header>

    <main class="container paper border-2 border col">
      <section style="display: grid; justify-items: center">
        <button
          id="avatar_button"
          class="container border-3 border-dashed shadow shadow-small"
          style="padding: 0px; margin: 20px; max-width: 28ch"
        >
          <img
            id="avatar"
            alt="avatar"
            :src="avatarImgSrc({seed:avatar_seed})"
            x-cloak
            draggable="false"
            style="border: 0; margin: 0"
          />
        </button>
        <input
          id="nickname_input"
          x-ref="nickname_input"
          type="text"
          placeholder="Nickname goes here"
          class="container border-3 border-dashed shadow shadow-hover shadow-small"
          x-init="$watch('nickname', setLocalStorage('nickname'))"
          x-model="nickname"
          maxlength="24"
          style="text-align: center; font-size: x-large; max-width: 24ch"
        />
      </section>
      <section
        class="row flex-center"
        style="margin-top: 20px; margin-bottom: 0"
      >
        <button
          x-on:click="openRoom"
          class="btn-secondary-outline"
          style="font-size: xx-large; font-variant: small-caps"
        >
          ⚔ Open Room
        </button>
        <button
          x-on:click="copyRoomLinkToClipboard"
          x-show="false"
          x-cloak
          class="margin"
        >
          🔗 Invite
        </button>
      </section>
    </main>

    <footer style="text-align: right">
      <p
        xmlns:cc="http://creativecommons.org/ns#"
        xmlns:dct="http://purl.org/dc/terms/"
        style="margin-bottom: 0; font-style: italic; font-size: small"
      >
        <a
          rel="cc:attributionURL"
          property="dct:title"
          href="https://github.com/jgrunik/upgrade"
          >Upgrade</a
        >
        by
        <a
          rel="cc:attributionURL dct:creator"
          property="cc:attributionName"
          href="https://github.com/jgrunik"
          >Joshua Grunik</a
        >
        is licensed under
        <a
          rel="license noopener noreferrer"
          href="http://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1"
          target="_blank"
          >CC BY-NC-SA 4.0</a
        >
        <br />
        <span style="display: inline-flex; height: 2ch">
          <img
            style="margin-left: 3px; vertical-align: text-bottom"
            src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"
          />
          <img
            style="margin-left: 3px; vertical-align: text-bottom"
            src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"
          />
          <img
            style="margin-left: 3px; vertical-align: text-bottom"
            src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1"
          /><img
            style="margin-left: 3px; vertical-align: text-bottom"
            src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1"
          />
        </span>
      </p>
    </footer>
  </body>
</html>
